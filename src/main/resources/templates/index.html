<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" class="has-background-grey-lighter">
<head>
    <meta charset="UTF-8">
    <title>Отзывы</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<header class="section">
    <div class="container">
        <div class="level">
            <div class="level-left">
                <a th:href="@{/}" class="title" style="text-decoration: none; color: inherit;">
                    <h1 class="title">Отзывы</h1>
                </a>
            </div>
            <div class="level-right">
                <button class="button is-primary">
                    <span class="icon">
                        <i class="fas fa-plus"></i>
                    </span>
                    <span>Создать отзыв</span>
                </button>
            </div>
        </div>
    </div>
</header>
<body>
<section class="section">
    <div class="container">
        <!-- Поиск -->
        <div class="field mb-5">
            <div class="control has-icons-left">
                <input class="input is-medium"
                       type="text"
                       id="searchInput"
                       placeholder="Поиск по названию...">
                <span class="icon is-left">
                    <i class="fas fa-search"></i>
                </span>
            </div>
        </div>

        <!-- Результаты -->
        <div id="resultsContainer">
            <div th:replace="~{fragments/review-list :: review-list}"></div>

            <!-- Пагинация -->
            <nav class="pagination is-centered" th:if="${totalPages > 1}">
                <a th:href="@{/(page=${currentPage > 0 ? currentPage - 1 : 0})}"
                   class="pagination-previous"
                   th:disabled="${currentPage == 0}">Назад</a>

                <a th:href="@{/(page=${currentPage < totalPages - 1 ? currentPage + 1 : currentPage})}"
                   class="pagination-next"
                   th:disabled="${currentPage == totalPages - 1}">Вперед</a>

                <ul class="pagination-list">
                    <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                        <a th:href="@{/(page=${i})}"
                           th:text="${i + 1}"
                           th:class="${i == currentPage} ? 'pagination-link is-current' : 'pagination-link'">
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</section>

<script>
    // Поиск с задержкой
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();

        searchTimeout = setTimeout(() => {
            if (query.length >= 3 || query.length === 0) {
                fetchResults(query);
            }
        }, 500);
    });

    // AJAX-запрос для поиска
    function fetchResults(query) {
        fetch(`/api/reviews/search?title=${encodeURIComponent(query)}`)
            .then(response => {
                if (!response.ok) throw new Error('Ошибка сервера');
                return response.text();
            })
            .then(html => {
                document.getElementById('resultsContainer').innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('resultsContainer').innerHTML = `
                    <article class="message is-danger">
                        <div class="message-body">
                            Ошибка при загрузке результатов: ${error.message}
                        </div>
                    </article>`;
            });
    }
</script>
</body>
</html>